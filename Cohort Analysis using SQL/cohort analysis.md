# Cohort Analysis using Snowflake SQL Queries

In this analysis, we perform cohort analysis on different variables such as invoices, customers, and revenues using Snowflake SQL queries. We use a retail dataset and focus on various cohort-related metrics.
  The dataset is downloaded from kaggle.com ("https://www.kaggle.com/datasets/jihyeseo/online-retail-data-set-from-uci-ml-repo").

## Table of Contents
- [Introduction](#introduction)
- [Cohort Analysis on Order Level](#cohort-analysis-on-order-level)
- [Cohort Analysis/Customer Retention Analysis on Customer Level](#cohort-analysiscustomer-retention-analysis-on-customer-level)
- [Cohort Analysis on Customer Lifetime Value](#cohort-analysis-on-customer-lifetime-value)
- [Additional Scenarios](#additional-scenarios)
- [Verification](#verification)

## Introduction

Cohort analysis is a powerful technique that allows us to gain a deeper understanding of customer behavior and business performance by organizing customers into groups based on a common characteristic or event. These groups, or cohorts, are usually formed based on the timing of a specific event, such as the customer's first purchase. By analyzing how cohorts of customers behave over time, we can identify trends, patterns, and potential areas for improvement in customer engagement and revenue generation.

The retail dataset we use in this analysis consists of various attributes such as `InvoiceNo`, `CustomerID`, `InvoiceDate`, `Quantity`, `UnitPrice`, and more. By leveraging this dataset and Snowflake's SQL capabilities, we aim to answer key questions related to customer behavior and business success. Our cohort analysis involves categorizing customers into cohorts based on their first purchase month, and then observing their subsequent activities over a predefined period.

## Purpose of Analysis

The primary objectives of our cohort analysis are as follows:

1. **Customer Retention:** We want to understand how well our business is retaining customers over time. By tracking cohorts of customers and their subsequent purchases, we can measure the percentage of customers who continue to make purchases after their initial transaction.

2. **Revenue Trends:** We seek to uncover revenue trends within different cohorts. This involves analyzing how the revenue generated by each cohort changes over subsequent months following the initial purchase.

3. **Customer Lifetime Value:** Our analysis aims to compute the customer lifetime value (CLV) for each cohort. CLV provides insights into the long-term value each cohort contributes to the business.

## Cohort Analysis on Order Level

The first cohort analysis focuses on order-level cohort analysis. We calculate the number of invoices for each cohort of customers based on their first purchase month.

```sql
-- Create a new database named SALES
CREATE DATABASE SALES;

-- Switch to using the SALES database
USE DATABASE SALES;

-- Create a new schema named COHORT_ANALYSIS
CREATE SCHEMA COHORT_ANALYSIS;

-- Switch to using the COHORT_ANALYSIS schema
USE SCHEMA COHORT_ANALYSIS;

-- Create a table named RETAIL with various columns to store retail data
CREATE OR REPLACE TABLE RETAIL (
    InvoiceNo varchar (10),
    StockCode varchar(20),
    Description varchar(100),
    Quantity number(8,2),
    InvoiceDate varchar(25),
    UnitPrice number(8,2),
    CustomerID number (10),
    Country varchar(25)
);
SELECT * FROM RETAIL LIMIT 5;
```

### Results of the query
  | INVOICENO | STOCKCODE | DESCRIPTION                      | QUANTITY | INVOICEDATE     | UNITPRICE | CUSTOMERID | COUNTRY        |
|-----------|-----------|----------------------------------|----------|-----------------|-----------|------------|----------------|
| 536365    | 85123A    | WHITE HANGING HEART T-LIGHT HOLDER | 6        | 1/12/10 8:26    | 2.55      | 17850      | United Kingdom |
| 536366    | 22633     | HAND WARMER UNION JACK            | 6        | 1/12/10 8:28    | 1.85      | 17850      | United Kingdom |
| 536367    | 84879     | ASSORTED COLOUR BIRD ORNAMENT     | 32       | 1/12/10 8:34    | 1.69      | 13047      | United Kingdom |
| 536368    | 22960     | JAM MAKING SET WITH JARS          | 6        | 1/12/10 8:34    | 4.25      | 13047      | United Kingdom |
| 536369    | 21756     | BATH BUILDING BLOCK WORD          | 3        | 1/12/10 8:35    | 5.95      | 13047      | United Kingdom |

```sql
-- Cohort Analysis on Order Level

-- Step 1: Create a Common Table Expression (CTE) named CTE1 to prepare data
WITH CTE1 AS (
    SELECT 
        InvoiceNo, CUSTOMERID, 
        to_date(INVOICEDATE, 'DD/MM/YY HH24:MI') AS INVOICEDATE, 
        ROUND(QUANTITY * UNITPRICE, 2) AS REVENUE
    FROM RETAIL
    WHERE CUSTOMERID IS NOT NULL
),

-- Step 2: Create CTE2 to calculate purchase and first purchase months
CTE2 AS (
    SELECT InvoiceNo, CUSTOMERID, INVOICEDATE, 
        DATE_TRUNC('MONTH', INVOICEDATE) AS PURCHASE_MONTH,
        DATE_TRUNC('MONTH', MIN(INVOICEDATE) OVER (PARTITION BY CUSTOMERID ORDER BY INVOICEDATE)) AS FIRST_PURCHASE_MONTH,
        REVENUE
    FROM CTE1
),

-- Step 3: Create CTE3 to determine cohort months
CTE3 AS (
    SELECT InvoiceNo, FIRST_PURCHASE_MONTH,
        CONCAT('Month_', datediff('MONTH', FIRST_PURCHASE_MONTH, PURCHASE_MONTH)) AS COHORT_MONTH
    FROM CTE2
)

-- Step 4: Perform the final query to pivot and count invoices by cohort months
SELECT *
FROM CTE3
PIVOT (
    COUNT(InvoiceNo) FOR COHORT_MONTH IN (
        'Month_0', 'Month_1', 'Month_2', 'Month_3', 'Month_4', 'Month_5',
        'Month_6', 'Month_7', 'Month_8', 'Month_9', 'Month_10', 'Month_11', 'Month_12'
    )
)
ORDER BY FIRST_PURCHASE_MONTH;

```
### Results of the query
| FIRST_PURCHASE_MONTH | 'Month_0' | 'Month_1' | 'Month_2' | 'Month_3' | 'Month_4' | 'Month_5' | 'Month_6' | 'Month_7' | 'Month_8' | 'Month_9' | 'Month_10' | 'Month_11' | 'Month_12' |
|----------------------|-----------|-----------|-----------|-----------|-----------|-----------|-----------|-----------|-----------|-----------|------------|------------|------------|
| 2010-12-01           | 1,701     | 677       | 573       | 747       | 610       | 799       | 732       | 686       | 653       | 791       | 760        | 1,130      | 395        |
| 2011-01-01           | 545       | 148       | 181       | 148       | 233       | 195       | 176       | 172       | 184       | 233       | 277        | 89         | 0          |
| 2011-02-01           | 473       | 135       | 113       | 162       | 141       | 131       | 123       | 164       | 134       | 187       | 40         | 0          | 0          |
| 2011-03-01           | 542       | 122       | 176       | 149       | 141       | 121       | 157       | 160       | 220       | 45        | 0          | 0          | 0          |
| 2011-04-01           | 385       | 109       | 91        | 78        | 83        | 91        | 94        | 120       | 32        | 0         | 0          | 0          | 0          |
| 2011-05-01           | 365       | 93        | 63        | 70        | 93        | 87        | 113       | 34        | 0         | 0         | 0          | 0          | 0          |
| 2011-06-01           | 296       | 70        | 57        | 91        | 79        | 129       | 30        | 0         | 0         | 0         | 0          | 0          | 0          |
| 2011-07-01           | 235       | 50        | 59        | 55        | 82        | 25        | 0         | 0         | 0         | 0         | 0          | 0          | 0          |
| 2011-08-01           | 203       | 59        | 70        | 69        | 26        | 0         | 0         | 0         | 0         | 0         | 0          | 0          | 0          |
| 2011-09-01           | 379       | 126       | 157       | 41        | 0         | 0         | 0         | 0         | 0         | 0         | 0          | 0          | 0          |
| 2011-10-01           | 453       | 165       | 56        | 0         | 0         | 0         | 0         | 0         | 0         | 0         | 0          | 0          | 0          |
| 2011-11-01           | 425	     | 55        | 0         | 0         | 0         | 0         | 0         | 0         | 0         | 0         | 0          | 0          | 0          |
| 2011-12-01           | 45        | 0         | 0         | 0         | 0         | 0         | 0         | 0         | 0         | 0         | 0          | 0          | 0          |























  
