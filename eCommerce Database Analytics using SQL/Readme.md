# Introduction

I've recently joined Maven Fuzzy Factory as an eCommerce Database Analyst, where I'm part of the startup team working closely with the CEO, Head of Marketing, and Website Manager. Our primary focus is to navigate the online retail space, analyze marketing channels, optimize website performance, and measure the impact of our new product launches.

# Data Information

Our database plays a pivotal role in our analysis and decision-making processes. It consists of six key tables:

1. **website_sessions**: This table holds essential information about website sessions, including details like session duration, user source, campaign, device type, and referral sources.

2. **website_pageviews**: Here, we store data related to website page views, tracking user activity across our web pages.

3. **products**: This table is dedicated to our product catalog, containing valuable data about our products, including their names and creation dates.

4. **orders**: We keep track of all customer orders in this table, capturing data on order IDs, website sessions, user IDs, primary products, items purchased, prices, and costs.

5. **order_items**: Each order can consist of multiple items, and this table stores the details of these items, such as product IDs, prices, and costs.

6. **order_item_refunds**: In case of any refunds, we meticulously record refund data here, including refund amounts and their associations with orders and items.

As we dive deeper into the data, my goal is to become the data expert for Maven Fuzzy Factory, providing mission-critical analyses that help drive our business forward and achieve our goals.

## Traffic Source Analysis

In the realm of eCommerce, understanding where your customers are coming from and which channels are driving the highest quality traffic is paramount. This analysis focuses on leveraging the UTM parameters stored in our database to identify paid website sessions and determine the revenue generated by these paid campaigns.

**1. Identifying Traffic Sources**

We commence by exploring the size of various traffic sources, primarily examining the UTM content that drives the most sessions within the specified dataset range.

```sql
SELECT utm_content,
       Count(DISTINCT website_session_id) AS sessions
FROM   website_sessions
WHERE  website_session_id BETWEEN 1000 AND 2000
GROUP  BY utm_content
ORDER  BY sessions DESC;
```

**Result:**

| utm_content | sessions |
|-------------|----------|
| g_ad_1      | 975      |
| null        | 18       |
| g_ad_2      | 6        |
| b_ad_2      | 2        |

In this context, 'g_ad_1' stands out as the dominant traffic source, driving 975 sessions. Null entries are also present, representing traffic without specific UTM content, totaling 18 sessions. Additionally, 'g_ad_2' and 'b_ad_2' contribute smaller session counts.

**2. Linking Traffic Sources to Orders**

Next, we expand our analysis to link these traffic sources to orders, gaining insights into how effectively these sources convert sessions into actual orders.

```sql
SELECT a.utm_content,
       Count(DISTINCT a.website_session_id) AS sessions,
       Count(DISTINCT b.order_id)           AS orders
FROM   website_sessions a
       LEFT JOIN orders b
              ON b.website_session_id = a.website_session_id
WHERE  a.website_session_id BETWEEN 1000 AND 2000
GROUP  BY a.utm_content
ORDER  BY sessions DESC;
```

**Result:**

| utm_content | sessions | orders |
|-------------|----------|--------|
| g_ad_1      | 975      | 35     |
| null        | 18       | 0      |
| g_ad_2      | 6        | 0      |
| b_ad_2      | 2        | 0      |

Unsurprisingly, 'g_ad_1' still leads in sessions with 975, contributing 35 orders. However, it's notable that 'null,' 'g_ad_2,' and 'b_ad_2' did not result in any orders during this period.

**3. Session-to-Order Conversion Rate**

To provide a comprehensive view, we calculate the session-to-order conversion rate for each traffic source.

```sql
SELECT a.utm_content,
       Count(DISTINCT a.website_session_id)    AS sessions,
       Count(DISTINCT b.order_id)              AS orders,
       Round(( Count(DISTINCT b.order_id) / Count(DISTINCT
             a.website_session_id) ) * 100, 2) AS sess_ord_conv_rate
FROM   website_sessions a
       LEFT JOIN orders b
              ON b.website_session_id = a.website_session_id
WHERE  a.website_session_id BETWEEN 1000 AND 2000
GROUP  BY a.utm_content
ORDER  BY sessions DESC;
```

**Result:**

| utm_content | sessions | orders | sess_ord_conv_rate |
|-------------|----------|--------|--------------------|
| g_ad_1      | 975      | 35     | 3.59               |
| null        | 18       | 0      | 0.00               |
| g_ad_2      | 6        | 0      | 0.00               |
| b_ad_2      | 2        | 0      | 0.00               |

When assessing the session-to-order conversion rates, 'g_ad_1' shows a rate of 3.59%. The other sources, including 'null,' 'g_ad_2,' and 'b_ad_2,' did not yield any conversions during this analyzed period.

In summary, this analysis provides insights into the effectiveness of various traffic sources in driving sessions and orders, with 'g_ad_1' being the most significant contributor to both sessions and orders. Understanding these conversion rates is crucial for optimizing our marketing strategies and improving the overall business performance.

**Analysis of Website Sessions â€“ UTM Source Breakdown**

**Request Explanation:**
Cindy, the date requested is April 12, 2012. The objective is to gain insights into the bulk of website sessions leading up to that date, specifically focusing on the breakdown by UTM source, campaign, and referring domain if available.

**SQL Query:**
```sql
select utm_content, utm_campaign, http_referer, count(DISTINCT website_session_id) as sessions
from website_sessions
where created_at < '2012-04-12'
GROUP BY utm_content, utm_campaign, http_referer
ORDER BY sessions DESC;
```

**SQL Query Explanation:**

1. `select utm_content, utm_campaign, http_referer, count(DISTINCT website_session_id) as sessions`: This part of the query selects the relevant columns from the `website_sessions` table, including UTM content, UTM campaign, HTTP referer, and calculates the count of distinct website session IDs, which represents the number of sessions.

2. `from website_sessions`: It specifies the source table from which the data is retrieved, which is the `website_sessions` table.

3. `where created_at < '2012-04-12'`: This clause filters the data based on the `created_at` column, ensuring that only records with a creation date before April 12, 2012, are included in the analysis.

4. `GROUP BY utm_content, utm_campaign, http_referer`: This clause groups the data by UTM content, UTM campaign, and HTTP referer, allowing for a breakdown of sessions by these parameters.

5. `ORDER BY sessions DESC`: The results are then ordered in descending order based on the number of sessions, with the most significant number of sessions appearing first in the output.

**Result:**

| utm_content | utm_campaign | http_referer            | sessions |
|-------------|--------------|-------------------------|----------|
| g_ad_1      | nonbrand     | https://www.gsearch.com | 3613     |
|             |              |                         | 28       |
|             |              | https://www.gsearch.com | 27       |
| g_ad_2      | brand        | https://www.gsearch.com | 26       |
|             | 7            | https://www.bsearch.com |          |
| b_ad_2      | brand        | https://www.bsearch.com | 7        |

**Interpretation:**

The provided data showcases a comprehensive breakdown of website sessions, sorted by UTM source, campaign, and referring domain. It's apparent that 'g_ad_1' nonbrand sessions from 'https://www.gsearch.com' dominate with 3613 sessions. Notably, there are several entries with null values for UTM content and campaign, which collectively contribute 28 sessions.

**Follow-up:**

As we observe the dominance of 'g_ad_1' nonbrand sessions, it is advisable to conduct a more detailed analysis of this particular source to identify optimization opportunities. To gain further insights and establish next steps, involving Tom for his expertise is a practical course of action.

**Request:**

Tom wants to determine the conversion rate (CVR) from website sessions to orders, specifically focusing on sessions generated through the "gsearch" source with a "nonbrand" campaign. The goal is to calculate whether the CVR meets the minimum threshold of 4% needed to make the financial numbers work. If the CVR is below this threshold, adjustments to reduce search bids might be necessary. Tom's request aims to evaluate the economic viability of their paid search campaigns.

**SQL Query:**
```sql
SELECT Count(DISTINCT a.website_session_id)    AS sessions,
       Count(DISTINCT b.order_id)              AS orders,
       Round(( Count(DISTINCT b.order_id) / Count(DISTINCT
             a.website_session_id) ) * 100, 2) AS CVR
FROM   website_sessions a
       LEFT JOIN orders b
              ON b.website_session_id = a.website_session_id
WHERE  a.created_at < '2012-04-14' 
       AND utm_source = "gsearch"
       AND utm_campaign = "nonbrand"
ORDER  BY 3 DESC; 
```

**SQL Query Explanation:**
- The query calculates the CVR by counting the number of distinct website sessions and orders.
- It computes the CVR by dividing the number of orders by the number of sessions and then multiplying by 100 to express it as a percentage.
- The query filters data based on the "gsearch" source and "nonbrand" campaign to focus on sessions from this specific marketing channel.
- Results are sorted in descending order based on the CVR.

**Answer:**
| # sessions | orders | CVR  |
|------------|--------|------|
| 3895       | 112    | 2.88 |

**Answer Interpretation:**
The analysis shows that the CVR for sessions generated through the "gsearch" source with a "nonbrand" campaign is approximately 2.88%. This CVR falls short of the 4% threshold needed to make the economics work for the paid search campaigns. Consequently, there is a need to reduce search bids since the current conversion rate indicates that they are over-spending.

**Comment by Tom:**
Tom acknowledges the analysis and mentions that, based on the findings, they need to dial down their search bids. The reason for this is that they are currently over-spending on their campaigns due to the lower-than-desired conversion rate. The analysis has helped them make more cost-effective decisions and saved them money.

**Request:**
The request is to analyze traffic sources and bid optimization based on website sessions and orders data. The goal is to understand the value of different segments of paid traffic for bid optimization.

**Query 1: Trended Sessions**
This query calculates the trended sessions by year and week. It focuses on sessions falling within the specified `website_session_id` range. The results include the year, week, the start date of the week, and the number of sessions for each week.

```sql
select year(created_at), week(created_at),
min(date(created_at)) as week_start,
count(DISTINCT website_session_id) as sessions
from website_sessions
where website_session_id BETWEEN 100000 AND 115000
GROUP BY 1,2;
```

**Explanation 1:**
The query extracts trended sessions, which are useful for understanding website traffic patterns over time. It filters sessions within the defined `website_session_id` range and groups them by year and week. The results show the number of sessions for each week, helping identify trends.

**Answer 1:**
The first answer provides trended sessions data, including the year, week, week start date, and the number of sessions for each week within the specified `website_session_id` range.

**Query 2: Pivot Table in SQL using Orders Data**
This query constructs a pivot table to analyze primary product categories' performance in terms of single-item and two-item orders. It counts the number of single-item and two-item orders for each primary product category within the specified `order_id` range.

```sql
select primary_product_id,
count(DISTINCT case when items_purchased = 1 then order_id else null end) as count_single_item_orders,
count(DISTINCT case when items_purchased = 2 then order_id else null end) as count_two_item_orders
from orders 
where order_id between 31000 AND 32000
GROUP BY 1;
```

**Explanation 2:**
This query creates a pivot table to show how different primary product categories perform in terms of order types. It categorizes orders as single-item or two-item orders and counts them for each primary product category within the specified `order_id` range. This analysis helps understand how products perform with different order types.

**Answer 2:**
The second answer offers a pivot table displaying the count of single-item and two-item orders for each primary product category in the specified `order_id` range.

**Request (May 10, 2012):**
The request is to analyze the trended session volume for the "gsearch nonbrand" traffic source by week. This analysis aims to determine if the bid changes made on 2012-04-15 have affected the volume of sessions for this traffic source.

**Query:**
This SQL query retrieves the week's starting date and the number of distinct website sessions for the "gsearch nonbrand" traffic source. It filters the data based on the created date and specific UTM source and campaign conditions.

```sql
SELECT Min(Date(created_at))              AS week_start,
       Count(DISTINCT website_session_id) AS sessions
FROM   website_sessions
WHERE  created_at < '2012-05-10'
       AND utm_source = "gsearch"
       AND utm_campaign = "nonbrand"
GROUP  BY Yearweek(created_at); 
```

**Explanation:**
The query extracts data on the number of website sessions for "gsearch nonbrand" by weeks. It calculates the starting date of each week and counts the sessions within the specified date range. The data is grouped by the year and week of the created date.

**Answer:**

| # week_start | sessions |
|--------------|----------|
| 2012-03-19   | 896      |
| 2012-03-25   | 956      |
| 2012-04-01   | 1152     |
| 2012-04-08   | 983      |
| 2012-04-15   | 621      |
| 2012-04-22   | 594      |
| 2012-04-29   | 681      |
| 2012-05-06   | 399      |

The answer table presents the week's starting date and the corresponding number of sessions for "gsearch nonbrand." This data allows for the assessment of changes in session volume over time, particularly concerning the bid adjustments.

**Comment by the Requester (Tom - May 10, 2012):**
The requester acknowledges the analysis and expresses that it appears that bid changes have a significant impact on the sensitivity of "gsearch nonbrand" traffic. While the goal is to maximize volume, it's crucial not to overspend on ads, and they plan to contemplate potential strategies based on this insight.

**Request (May 11, 2012):**
The request is to calculate conversion rates from website session to order, categorized by device type (desktop and mobile). This analysis aims to compare the performance of desktop and mobile devices. The goal is to identify whether desktop performance is superior to mobile performance, as this insight could inform bid adjustments for desktop to potentially increase sales volume.

**Query:**
This SQL query retrieves data related to website sessions and orders. It calculates the number of sessions, orders, and the conversion rate (CVR) for each device type. The data is filtered based on various conditions, including the created date and specific UTM source and campaign criteria.

```sql
SELECT a.device_type,
       Count(DISTINCT a.website_session_id)    AS sessions,
       Count(DISTINCT b.order_id)              AS orders,
       Round(( Count(DISTINCT b.order_id) / Count(DISTINCT a.website_session_id) ) * 100, 2) AS CVR
FROM   website_sessions a
       LEFT JOIN orders b
              ON b.website_session_id = a.website_session_id
WHERE  a.created_at < '2012-05-11' 
       AND utm_source = "gsearch"
       AND utm_campaign = "nonbrand"
GROUP BY 1
ORDER  BY 3 DESC; 
```

**Explanation:**
The query fetches data related to the number of website sessions and orders, and it calculates the conversion rate (CVR) for both desktop and mobile devices. It joins data from the "website_sessions" and "orders" tables based on the website session ID. The data is filtered by specific conditions, including the created date, UTM source, and campaign criteria. The result is grouped by device type and sorted by the order count in descending order.

**Answer:**

| # device_type | sessions | orders | CVR  |
|---------------|----------|--------|------|
| desktop       | 3911     | 146    | 3.73 |
| mobile        | 2492     | 24     | 0.96 |

The answer table presents the device types (desktop and mobile), along with the number of sessions, orders, and the corresponding conversion rates (CVR). This data provides insights into the performance of each device type, with desktop showing a significantly higher CVR compared to mobile.

**Comment by the Requester (Tom - May 11, 2012):**
The requester acknowledges the results and confirms their decision to increase bids specifically for desktop devices. By bidding higher, they aim to improve their ranking in auctions, which, based on the provided insights, is expected to boost sales. The requester praises the analysis and expresses gratitude for the insights.

**Request (June 09, 2012):**
In this request, the requester asks for an analysis of weekly trends for both desktop and mobile devices following recent bid changes for "gsearch nonbrand" campaigns. The analysis aims to understand the impact on website session volumes for desktop and mobile devices after the bid changes. The specified date range for the analysis is from April 15, 2012, to June 9, 2012. This period is considered the baseline for comparison.

**Query:**
This SQL query is designed to retrieve data related to website sessions. It calculates the count of sessions for both desktop and mobile devices and categorizes them by week. The data is filtered based on specific conditions, including the created date and UTM source and campaign criteria.

```sql
SELECT 
min(date(created_at)) as week_start,
Count(DISTINCT case when device_type = "desktop" then website_session_id else null end) AS dtop_sessions,
Count(DISTINCT case when device_type = "mobile" then website_session_id else null end) AS mob_sessions
FROM   website_sessions 
WHERE  created_at >= '2012-04-15' AND created_at < '2012-06-9' 
and utm_source = "gsearch"
and utm_campaign = "nonbrand"
GROUP BY yearweek(created_at);
```

**Explanation:**
The query retrieves website session data for both desktop and mobile devices, categorizing sessions by week. It uses conditional statements to count sessions specifically for each device type. The data is filtered based on specific date ranges, UTM source, and campaign criteria, allowing the comparison of trends for desktop and mobile devices.

**Answer:**
| # week_start | dtop_sessions | mob_sessions |
|--------------|---------------|--------------|
| 2012-04-15   | 383           | 238          |
| 2012-04-22   | 360           | 234          |
| 2012-04-29   | 425           | 256          |
| 2012-05-06   | 430           | 282          |
| 2012-05-13   | 403           | 214          |
| 2012-05-20   | 661           | 190          |
| 2012-05-27   | 585           | 183          |
| 2012-06-03   | 582           | 157          |

The answer table presents the week start date, along with the number of sessions for desktop and mobile devices in each corresponding week. The data shows how session volumes have changed during the specified period, following the bid changes. This information provides insights into the impact of bid adjustments on website session volumes for different devices.

**Extra Analysis:**
An additional SQL query is provided, showing the device type, week start date, session count, order count, and conversion rate (CVR) for both desktop and mobile devices during the same date range. This extra analysis allows for a more detailed understanding of the performance of each device type.
```sql
SELECT a.device_type,
min(date(a.created_at)) as week_start,
Count(DISTINCT a.website_session_id)    AS sessions,
       Count(DISTINCT b.order_id)              AS orders,
       Round(( Count(DISTINCT b.order_id) / Count(DISTINCT
             a.website_session_id) ) * 100, 2) AS CVR
FROM   website_sessions a
       LEFT JOIN orders b
              ON b.website_session_id = a.website_session_id
WHERE  a.created_at>='2012-04-15' AND a.created_at < '2012-06-9' 
and utm_source = "gsearch"
and utm_campaign = "nonbrand"
GROUP BY 1, yearweek(a.created_at);
```
**ANSWER:**
| # device_type | week_start | sessions | orders | CVR  |
|---------------|------------|----------|--------|------|
| desktop       | 2012-04-15 | 383      | 11     | 2.87 |
| desktop       | 2012-04-22 | 360      | 13     | 3.61 |
| desktop       | 2012-04-29 | 425      | 12     | 2.82 |
| desktop       | 2012-05-06 | 430      | 14     | 3.26 |
| desktop       | 2012-05-13 | 403      | 15     | 3.72 |
| desktop       | 2012-05-20 | 661      | 25     | 3.78 |
| desktop       | 2012-05-27 | 585      | 27     | 4.62 |
| desktop       | 2012-06-03 | 582      | 25     | 4.30 |
| mobile        | 2012-04-15 | 238      | 6      | 2.52 |
| mobile        | 2012-04-22 | 234      | 1      | 0.43 |
| mobile        | 2012-04-29 | 256      | 2      | 0.78 |
| mobile        | 2012-05-06 | 282      | 1      | 0.35 |
| mobile        | 2012-05-13 | 214      | 3      | 1.40 |
| mobile        | 2012-05-20 | 190      | 0      | 0.00 |
| mobile        | 2012-05-27 | 183      | 2      | 1.09 |
| mobile        | 2012-06-03 | 157      | 2      | 1.27 |

**Comment by the Requester (Tom - June 09, 2012):**
The requester acknowledges the analysis results and expresses satisfaction with the insights. They note that the mobile performance appears to have been relatively flat or slightly declining, while desktop performance has improved due to the bid changes made based on the previous conversion rate analysis. The requester appreciates the positive direction in which things are moving.

## ANALYZING TOP WEBSITE CONTENT:

The goal of this analysis is to understand which pages on a website receive the most traffic. This information can help identify the most popular content and, in turn, guide improvements to enhance the user experience or business strategies.

**SQL Query:**

```sql
-- Retrieve the first 100 website_pageviews
select * from website_pageviews
where website_pageview_id < 1000;
```

**Explanation:**

This SQL query retrieves the first 100 rows from the `website_pageviews` table based on the `website_pageview_id` column. It provides a glimpse of the data, showing the pageview details, including the `website_pageview_id`, `created_at` timestamp, `website_session_id`, and the `pageview_url`.

**Answer:**

| # website_pageview_id | created_at          | website_session_id | pageview_url              |
|-----------------------|---------------------|--------------------|---------------------------|
| 1                     | 2012-03-19 08:04:16 | 1                  | /home                     |
| 2                     | 2012-03-19 08:16:49 | 2                  | /home                     |
| 3                     | 2012-03-19 08:26:55 | 3                  | /home                     |
| 4                     | 2012-03-19 08:37:33 | 4                  | /home                     |
| 5                     | 2012-03-19 09:00:55 | 5                  | /home                     |
| 6                     | 2012-03-19 09:05:46 | 6                  | /home                     |
| 7                     | 2012-03-19 09:06:27 | 7                  | /home                     |
| 8                     | 2012-03-19 09:10:08 | 6                  | /products                 |
| 9                     | 2012-03-19 09:10:52 | 6                  | /the-original-mr-fuzzy    |
| 10                    | 2012-03-19 09:14:02 | 6                  | /cart                     |
| ...                   | ...                 | ...                | ...                       |

The answer shows a portion of the `website_pageviews` table, indicating the website pages visited during specific sessions.

**SQL Query:**

```sql
-- Top-Content analysis [pages with most views]
select pageview_url, count(DISTINCT website_pageview_id) as pageviews
from website_pageviews
where website_pageview_id < 1000
GROUP BY 1
ORDER BY 2 DESC;
```

**Explanation:**

This SQL query aims to identify the most viewed website pages. It counts the distinct `website_pageview_id` values for each `pageview_url`, filtering only the records where `website_pageview_id` is less than 1000. The results are then grouped by `pageview_url` and ordered by the count of pageviews in descending order.

**Answer:**

| # pageview_url            | pageviews |
|---------------------------|-----------|
| /home                     | 523       |
| /products                 | 195       |
| /the-original-mr-fuzzy    | 134       |
| /cart                     | 56        |
| /shipping                 | 39        |
| /billing                  | 34        |
| /thank-you-for-your-order | 18        |

The answer table displays the website pages with the most views (pageview_url) and the respective count of pageviews. The "/home" page is the most visited, with 523 pageviews.

**SQL Query:**

```sql
-- Top ENTRY Pages
with
cte1 as(select website_session_id, min(website_pageview_id) as first_entry
from website_pageviews
where website_pageview_id < 1000
GROUP BY 1)
SELECT b.pageview_url, count(DISTINCT a.website_session_id ) as number_of_times_first_entered from cte1 a
left join website_pageviews b on a.first_entry = b.website_pageview_id
GROUP BY 1;
```

**Explanation:**

This SQL query focuses on identifying the top entry pages. It utilizes a Common Table Expression (CTE) named `cte1` to find the first pageview (`first_entry`) for each session (`website_session_id`) from the `website_pageviews` table where `website_pageview_id` is less than 1000. It then joins the CTE with the `website_pageviews` table to find the pageview_url of the first entry. The results are grouped by `pageview_url`, and the count of distinct sessions is calculated to show how many times each page served as the entry point.

**Answer:**

| # pageview_url | number_of_times_first_entered |
|----------------|-------------------------------|
| /home          | 523                           |

The answer table presents the pageview_url that served as the entry point the most, which is "/home," with 523 occurrences.

In summary, this analysis provides insights into the most popular pages on the website, with "/home" being the top-viewed page and the most frequently used entry point. This information can be valuable for optimizing and tailoring content and strategies to meet user preferences and business objectives.

**Request - June 09, 2012:**

Hi there!
Iâ€™m Morgan, the new Website Manager.
Could you help me get my head around the site by pulling the most-viewed website pages, ranked by session volume?
Thanks!
-Morgan

**SQL Query:**

```sql
select pageview_url,
count(DISTINCT website_pageview_id) as sessions
from website_pageviews
where created_at < '2012-06-09'
GROUP BY 1
ORDER BY 2 DESC;
```

**Explanation:**

In this request, Morgan, the Website Manager, asks for assistance in understanding the most-viewed website pages, ranked by session volume. The SQL query retrieves data from the `website_pageviews` table, counting the number of distinct session IDs for each `pageview_url` before June 9, 2012. The results are grouped by `pageview_url` and ordered by the count of sessions in descending order.

**Answer:**

| # pageview_url            | sessions |
|---------------------------|----------|
| /home                     | 10403    |
| /products                 | 4239     |
| /the-original-mr-fuzzy    | 3037     |
| /cart                     | 1306     |
| /shipping                 | 869      |
| /billing                  | 716      |
| /thank-you-for-your-order | 306      |

The answer table provides a list of the most-viewed website pages, with session counts. It reveals that the homepage ("/home") received the highest number of sessions, followed by the products page and the Mr. Fuzzy page.

**Comment**
Thank you! It definitely seems like the homepage, the products page, and the Mr. Fuzzy page get the bulk of our traffic. I would like to understand traffic patterns more. Iâ€™ll follow up soon with a request to look at entry pages. Thanks! -Morgan

**Request - June 12, 2012:**

Hi there! Would you be able to pull a list of the top entry pages? I want to confirm where our users are hitting the site. If you could pull all entry pages and rank them on entry volume, that would be great. Thanks! -Morgan

**SQL Query:**

```sql
with
cte1 as(select website_session_id, min(website_pageview_id) as first_entry
from website_pageviews
where created_at < '2012-06-12'
GROUP BY 1)
SELECT b.pageview_url, count(DISTINCT a.website_session_id ) as number_of_times_first_entered from cte1 a
left join website_pageviews b on a.first_entry = b.website_pageview_id
GROUP BY 1;
```

**Explanation:**

In the second request, Morgan seeks to understand the entry points of website users. The SQL query first creates a Common Table Expression (CTE) named `cte1`, which identifies the first entry page (`first_entry`) for each session before June 12, 2012. It groups the results by `website_session_id`. The main query then joins this CTE with the `website_pageviews` table to determine which pages users first enter and calculates the count of distinct sessions for each entry page.

**Answer:**

| # pageview_url | number_of_times_first_entered |
|----------------|-------------------------------|
| /home          | 10714                         |

The answer table displays the top entry pages ranked by entry volume. In this case, the homepage ("/home") is the primary entry point, with 10,714 instances.

**Comment:**
In the comment following the second request, Morgan acknowledges that all the website traffic comes in through the homepage. They find it quite obvious that this is the area where they should focus on making improvements, and they hint at the possibility of follow-up requests to examine the performance of the homepage. It shows an understanding of the importance of the homepage as the initial point of interaction with users and the potential for optimization in that area. Morgan's request and comments suggest a proactive approach to website management and improvement.

## LANDING PAGE PERFORMANCE & TESTING:

The goal of this SQL analysis is to evaluate the performance of landing pages during a specific time period. The analysis involves multiple steps:
1. Finding the first website pageview for relevant sessions.
2. Identifying the landing page for each session.
3. Counting pageviews for each session to identify "bounces" (sessions where users viewed only one page).
4. Summarizing the total sessions and bounced sessions, categorized by landing pages.

**SQL Query:**
```sql
WITH
-- First website_pageview_id for relevant sessions
cte1 AS (
    SELECT website_session_id, MIN(website_pageview_id) AS first_entry
    FROM website_pageviews
    WHERE created_at BETWEEN '2014-01-01' AND '2014-02-01'
    GROUP BY 1
),
-- Identifying the landing page of each session
cte2 AS (
    SELECT a.website_session_id, b.pageview_url AS landing_page
    FROM cte1 a
    LEFT JOIN website_pageviews b ON a.first_entry = b.website_pageview_id
),
-- Counting pageviews for each session to identify "bounces"
cte3 AS (
    SELECT a.website_session_id, a.landing_page, COUNT(b.website_pageview_id) AS count_of_pages_viewed
    FROM cte2 a
    LEFT JOIN website_pageviews b ON b.website_session_id = a.website_session_id
    GROUP BY 1, 2
    HAVING COUNT(b.website_pageview_id) = 1
),
-- Merging all sessions and bounced sessions in a single table
cte4 AS (
    SELECT a.landing_page, a.website_session_id, b.website_session_id AS bounced_website_session_id
    FROM cte2 a
    LEFT JOIN cte3 b ON a.website_session_id = b.website_session_id
    ORDER BY a.website_session_id
)
-- Summarizing the total sessions and bounced sessions, by Landing Pages
SELECT landing_page,
       COUNT(DISTINCT website_session_id) AS sessions,
       COUNT(DISTINCT bounced_website_session_id) AS bounced_sessions,
       ROUND((COUNT(DISTINCT bounced_website_session_id) / COUNT(DISTINCT website_session_id)) * 100, 2) AS bounced_cvr
FROM cte4
GROUP BY 1
ORDER BY bounced_cvr DESC;
```

**Explanation:**

1. **cte1:** The first Common Table Expression (CTE) `cte1` identifies the first pageview (`first_entry`) for each relevant session that occurred between January 1, 2014, and February 1, 2014.

2. **cte2:** The second CTE `cte2` associates each session with its landing page by joining the first pageview URL with the session ID.

3. **cte3:** The third CTE `cte3` counts the number of pageviews for each session, and only includes sessions where users viewed just one page, indicating a "bounce."

4. **cte4:** The fourth CTE `cte4` merges all sessions with their bounced sessions by joining `cte2` and `cte3`.

5. The final query summarizes the data. It groups the results by landing pages and calculates the total sessions, bounced sessions, and the bounce rate (bounced_cvr) as a percentage of total sessions.

**Answer:**

| # landing_page | sessions | bounced_sessions | bounced_cvr |
|----------------|----------|------------------|-------------|
| /lander-3      | 4232     | 2606             | 61.58       |
| /lander-2      | 6500     | 2855             | 43.92       |
| /home          | 4093     | 1575             | 38.48       |
| /products      | 1        | 0                | 0.00        |

The answer table provides landing page performance data for the specified time period. It includes the landing page URLs, the number of sessions, the number of bounced sessions, and the bounce rate. The landing page "/lander-3" has the highest bounce rate at 61.58%, followed by "/lander-2" at 43.92%. The homepage "/home" and "/products" have lower bounce rates.

This analysis helps in understanding how well landing pages are retaining users, and it highlights areas that may need improvement to reduce bounce rates and increase user engagement.

**Request (June 14, 2012):**
Morgan requested information about the performance of the landing page, specifically the homepage. They wanted to know the sessions, bounced sessions, and the bounce rate for traffic landing on the homepage.

**SQL Query:**
```sql
WITH
-- First website_pageview_id for relevant sessions
cte1 AS (
    SELECT website_session_id, MIN(website_pageview_id) AS first_entry
    FROM website_pageviews
    WHERE created_at < '2012-06-14'
    GROUP BY 1
),
-- Identifying the landing page of each session
cte2 AS (
    SELECT a.website_session_id, b.pageview_url AS landing_page
    FROM cte1 a
    LEFT JOIN website_pageviews b ON a.first_entry = b.website_pageview_id
),
-- Counting pageviews for each session to identify "bounces"
cte3 AS (
    SELECT a.website_session_id, a.landing_page, COUNT(b.website_pageview_id) AS count_of_pages_viewed
    FROM cte2 a
    LEFT JOIN website_pageviews b ON b.website_session_id = a.website_session_id
    GROUP BY 1, 2
    HAVING COUNT(b.website_pageview_id) = 1
),
-- Merging all sessions and bounced sessions in a single table
cte4 AS (
    SELECT a.landing_page, a.website_session_id, b.website_session_id AS bounced_website_session_id
    FROM cte2 a
    LEFT JOIN cte3 b ON a.website_session_id = b.website_session_id
    ORDER BY a.website_session_id
)
-- Summarizing the total sessions and bounced sessions, by Landing Pages
SELECT landing_page,
       COUNT(DISTINCT website_session_id) AS sessions,
       COUNT(DISTINCT bounced_website_session_id) AS bounced_sessions,
       ROUND((COUNT(DISTINCT bounced_website_session_id) / COUNT(DISTINCT website_session_id)) * 100, 2) AS bounced_cvr
FROM cte4
GROUP BY 1
ORDER BY bounced_cvr DESC;
```

**Explanation:**
The SQL query begins by identifying the first website pageview for relevant sessions within a specified time period. It then associates each session with its landing page and counts pageviews to identify bounced sessions (sessions with only one pageview). The data is summarized for the homepage, showing the number of sessions, bounced sessions, and the bounce rate.

**Answer:**

| # landing_page | sessions | bounced_sessions | bounced_cvr |
|----------------|----------|------------------|-------------|
| /home          | 11048    | 6538             | 59.18       |

The answer table provides the requested information for the homepage. The homepage "/home" had a total of 11,048 sessions, out of which 6,538 sessions resulted in bounces, resulting in a bounce rate of 59.18%.

**Comment by the Requester:**
Morgan acknowledges the high bounce rate of almost 60% and expresses concern about the quality of paid search traffic. They plan to create a custom landing page for search and set up an experiment to analyze its performance with the help of more data. The comment indicates that Morgan intends to take actions to improve the bounce rate on the homepage.

**Request (July 28, 2012):**
Morgan requested bounce rate information for two specific landing pages, "/home" and "/lander-1." These pages were part of a 50/50 test for gsearch nonbrand traffic. Morgan wanted to evaluate the new page, "/lander-1," by comparing the bounce rates for the two pages during the time period when "/lander-1" was receiving traffic.

**SQL Query:**
```sql
-- Finding out the /lander-1 first view date
SELECT created_at, Min(website_pageview_id)
FROM website_pageviews
WHERE pageview_url = "/lander-1"
GROUP BY 1
LIMIT 1;

WITH
-- First website_pageview_id for relevant sessions
cte1 AS (
    SELECT a.website_session_id, Min(a.website_pageview_id) AS first_entry
    FROM website_pageviews a
    INNER JOIN website_sessions b
    ON b.website_session_id = a.website_session_id
    AND b.created_at > '2012-06-19'
    AND b.created_at < '2012-07-28'
    AND b.utm_source = "gsearch"
    AND b.utm_campaign = "nonbrand"
    GROUP BY 1
),
-- Identifying the landing page of each session
cte2 AS (
    SELECT a.website_session_id, b.pageview_url AS landing_page
    FROM cte1 a
    LEFT JOIN website_pageviews b ON a.first_entry = b.website_pageview_id
),
-- Counting pageviews for each session to identify "bounces"
cte3 AS (
    SELECT a.website_session_id, a.landing_page, COUNT(b.website_pageview_id) AS count_of_pages_viewed
    FROM cte2 a
    LEFT JOIN website_pageviews b ON b.website_session_id = a.website_session_id
    GROUP BY 1, 2
    HAVING COUNT(b.website_pageview_id) = 1
),
-- Merging all sessions and bounced sessions in a single table
cte4 AS (
    SELECT a.landing_page, a.website_session_id, b.website_session_id AS bounced_website_session_id
    FROM cte2 a
    LEFT JOIN cte3 b ON a.website_session_id = b.website_session_id
    ORDER BY a.website_session_id
)
-- Summarizing the total sessions and bounced sessions, by Landing Pages
SELECT landing_page,
       COUNT(DISTINCT website_session_id) AS sessions,
       COUNT(DISTINCT bounced_website_session_id) AS bounced_sessions,
       ROUND((COUNT(DISTINCT bounced_website_session_id) / COUNT(DISTINCT website_session_id)) * 100, 2) AS bounce_rate
FROM cte4
GROUP BY 1
ORDER BY bounce_rate DESC;
```

**Explanation:**
The SQL query begins by identifying the first view date of the "/lander-1" landing page. It then calculates the bounce rates for both "/home" and "/lander-1" landing pages during the specified time period and for gsearch nonbrand traffic. The bounce rate is calculated as the percentage of bounced sessions out of the total sessions.

**Answer:**

| # landing_page | sessions | bounced_sessions | bounce_rate |
|----------------|----------|------------------|-------------|
| /home          | 2261     | 1319             | 58.34       |
| /lander-1      | 2316     | 1233             | 53.24       |

The answer table provides the requested information for the two landing pages. For "/home," there were 2,261 sessions with 1,319 bounced sessions, resulting in a bounce rate of 58.34%. For "/lander-1," there were 2,316 sessions with 1,233 bounced sessions, resulting in a lower bounce rate of 53.24%.

**Comment by the Requester:**
Morgan expresses satisfaction with the results, noting that the custom landing page "/lander-1" has a lower bounce rate, indicating success. Morgan plans to update campaigns to direct all nonbrand paid traffic to the new page. They also express the intention to have trends analyzed in a few weeks to ensure that things have moved in the right direction.

**Request (August 31, 2012):**
Morgan requested data related to paid search nonbrand traffic landing on two pages, "/home" and "/lander-1," trended weekly since June 1st. The goal was to confirm that the traffic routing was correct and to assess the impact of the change on the overall paid search bounce rate.

**SQL Query:**
```sql
WITH
-- First website_pageview_id for relevant sessions
cte1 AS (
    SELECT a.website_session_id, Min(a.website_pageview_id) AS first_entry, a.created_at
    FROM website_pageviews a
    INNER JOIN website_sessions b
    ON b.website_session_id = a.website_session_id
    AND a.created_at > '2012-06-01'
    AND a.created_at < '2012-08-31'
    AND b.utm_source = "gsearch"
    AND b.utm_campaign = "nonbrand"
    GROUP BY 1, 3
),
-- Identifying the landing page of each session
cte2 AS (
    SELECT a.website_session_id, a.first_entry, b.pageview_url AS landing_page, a.created_at
    FROM cte1 a
    LEFT JOIN website_pageviews b ON a.first_entry = b.website_pageview_id
),
-- Counting pageviews for each session to identify "bounces"
cte3 AS (
    SELECT a.website_session_id, a.first_entry, a.landing_page, Count(b.website_pageview_id) AS count_of_pages_viewed, a.created_at
    FROM cte2 a
    LEFT JOIN website_pageviews b ON b.website_session_id = a.website_session_id
    GROUP BY 1, 2, 5
)
-- Summarizing the total sessions and bounced sessions, by Landing Pages
SELECT Min(Date(created_at)) AS week_start,
       Round(( Count(DISTINCT CASE WHEN count_of_pages_viewed = 1 THEN website_session_id ELSE NULL END) / Count(DISTINCT website_session_id) ) * 100, 2) AS bounce_rate,
       Count(DISTINCT CASE WHEN landing_page = "/home" THEN website_session_id ELSE NULL END) AS home_sessions,
       Count(DISTINCT CASE WHEN landing_page = "/lander-1" THEN website_session_id ELSE NULL END) AS lander1_sessions
FROM cte3
GROUP BY Yearweek(created_at);
```

**Explanation:**
The SQL query retrieves data for two landing pages, "/home" and "/lander-1," and trends it weekly since June 1st for paid search nonbrand traffic. The query calculates the bounce rate, home sessions, and "/lander-1" sessions. Data is grouped by week using the `Yearweek` function.

**Answer:**

| # week_start | bounce_rate | home_sessions | lander1_sessions |
|--------------|-------------|---------------|------------------|
| 2012-06-01   | 60.23       | 175           | 0                |
| 2012-06-03   | 58.71       | 792           | 0                |
| 2012-06-10   | 61.60       | 875           | 0                |
| 2012-06-17   | 55.82       | 492           | 350              |
| 2012-06-24   | 58.28       | 369           | 386              |
| 2012-07-01   | 58.21       | 392           | 388              |
| 2012-07-08   | 56.68       | 390           | 411              |
| 2012-07-15   | 54.24       | 429           | 421              |
| 2012-07-22   | 51.38       | 402           | 394              |
| 2012-07-29   | 49.71       | 33            | 995              |
| 2012-08-05   | 53.82       | 0             | 1087             |
| 2012-08-12   | 51.40       | 0             | 998              |
| 2012-08-19   | 50.05       | 0             | 1012             |
| 2012-08-26   | 53.78       | 0             | 833              |

The answer table provides the requested data, showing the trend for each week. It includes the weekly start date, bounce rate, home sessions, and "/lander-1" sessions.

**Comment by the Requester:**
Morgan expresses gratitude for the provided data, indicating that both pages received traffic for a while and the full switch to the custom lander was successful. They also note that the overall bounce rate has decreased over time, which is considered positive. Morgan mentions plans for a deep dive into the site and hints at future requests.

## ANALYZING & TESTING CONVERSION FUNNELS:

Conversion funnel analysis is a crucial aspect of understanding and optimizing the user journey towards making a purchase or completing a specific action on a website. It involves examining the steps in the conversion flow to evaluate how many users progress through each step and how many drop off at each stage. This analysis helps businesses identify bottlenecks and opportunities for improvement in their conversion process.

**Business Context:**

The request seeks to perform a mini conversion funnel analysis from the "/lander-2" page to the "/cart" page. The primary objectives are to determine the number of users who reach each step in the funnel and calculate drop-off rates. This analysis is specifically focused on the "/lander-2" traffic and customers who have an interest in a product named "Mr. Fuzzy."

**SQL Query 1 (Counting Users at Each Funnel Step):**

```sql
WITH
-- Step 1: Select All Pageviews for Relevant Sessions (CTE1)
cte1 AS (
    SELECT a.website_session_id, b.pageview_url, b.created_at as pageview_created_at,
    CASE WHEN pageview_url = '/products' THEN 1 ELSE 0 END AS product_page,
    CASE WHEN pageview_url = '/the-original-mr-fuzzy' THEN 1 ELSE 0 END AS mrfuzzy_page,
    CASE WHEN pageview_url = '/cart' THEN 1 ELSE 0 END AS cart_page
    FROM website_sessions a
    LEFT JOIN website_pageviews b ON a.website_session_id = b.website_session_id
    WHERE a.created_at BETWEEN '2014-01-01' AND '2014-02-01'
    AND b.pageview_url IN ('/lander-2', '/products', '/the-original-mr-fuzzy', '/cart')
    ORDER BY 1, 3
),
-- Step 2: Identify Each Relevant Pageview as a Funnel Step (CTE2)
cte2 AS (
    SELECT website_session_id, MAX(product_page) AS product_made_it, MAX(mrfuzzy_page) AS mrfuzzy_made_it, MAX(cart_page) AS cart_made_it
    FROM cte1
    GROUP BY 1
)
-- Step 3: Create the Session-Level Conversion Funnel View (Main Query)
SELECT 
    COUNT(DISTINCT website_session_id) AS sessions,
    COUNT(DISTINCT CASE WHEN product_made_it = 1 THEN website_session_id ELSE NULL END) AS to_product,
    COUNT(DISTINCT CASE WHEN mrfuzzy_made_it = 1 THEN website_session_id ELSE NULL END) AS to_mrfuzzy,
    COUNT(DISTINCT CASE WHEN cart_made_it = 1 THEN website_session_id ELSE NULL END) AS to_cart
FROM cte2;
```

**Explanation of Query 1:**

1. **Step 1 (CTE1)** selects relevant pageviews for sessions within the specified date range and matching specific pageview URLs that correspond to the conversion funnel steps. It assigns binary values to each pageview URL to track if a session reached a specific step.

2. **Step 2 (CTE2)** summarizes the data by grouping it based on the website session. It calculates binary values for each session, indicating whether they reached the '/products,' '/the-original-mr-fuzzy,' and '/cart' pages.

3. **Step 3 (Main Query)** calculates the following metrics:
   - `sessions`: The total number of distinct sessions that meet the criteria.
   - `to_product`: The number of sessions that reached the '/products' page (the first step of the funnel).
   - `to_mrfuzzy`: The number of sessions that reached the '/the-original-mr-fuzzy' page (the second step of the funnel).
   - `to_cart`: The number of sessions that reached the '/cart' page (the final step of the funnel).

**Answer Table for Query 1:**

| # sessions | to_product | to_mrfuzzy | to_cart |
|------------|------------|------------|---------|
| 10644      | 7789       | 4777       | 2889    |

- `sessions`: 10,644 sessions were considered in the analysis.
- `to_product`: 7,789 sessions progressed to the '/products' page.
- `to_mrfuzzy`: 4,777 sessions reached the '/the-original-mr-fuzzy' page.
- `to_cart`: 2,889 sessions advanced to the '/cart' page.

**SQL Query 2 (Calculating Click-Through Rates):**

```sql
WITH
-- Reusing the CTE1 and CTE2 from Query 1
-- Step 3: Create the Session-Level Conversion Funnel View (Main Query)
SELECT 
    COUNT(DISTINCT website_session_id) AS sessions,
    ROUND((COUNT(DISTINCT CASE WHEN product_made_it = 1 THEN website_session_id ELSE NULL END) / COUNT(DISTINCT website_session_id)) * 100, 2) AS lander_clickthrough_rate,
    ROUND((COUNT(DISTINCT CASE WHEN mrfuzzy_made_it = 1 THEN website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN product_made_it = 1 THEN website_session_id ELSE NULL END)) * 100, 2) AS product_clickthrough_rate,
    ROUND((COUNT(DISTINCT CASE WHEN cart_made_it = 1 THEN website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN mrfuzzy_made_it = 1 THEN website_session_id ELSE NULL END)) * 100, 2) AS mrfuzzy_clickthrough_rate
FROM cte2;
```

**Explanation of Query 2:**

This query is a continuation of the analysis, using the same CTEs (CTE1 and CTE2) established in Query 1. It calculates click-through rates for each step of the conversion funnel.

- `lander-clickthrough_rate`: The click-through rate from '/lander-2' to '/products.'
- `product-clickthrough_rate`: The click-through rate from '/products' to '/the-original-mr-fuzzy.'
- `mrfuzzy-clickthrough_rate`: The click-through rate from '/the-original-mr-fuzzy' to '/cart.'

**Answer Table for Query 2:**

| # sessions | lander_clickthrough_rate | product_clickthrough_rate | mrfuzzy_clickthrough_rate |
|------------|--------------------------|---------------------------|---------------------------|
| 10644      | 73.18                    | 61.33                     | 60.48                     |

- `sessions`: 10,644 sessions are part of the analysis.
- `lander-clickthrough_rate`: The click-through rate from '/lander-2' to '/products' is 73.18%.
- `product-clickthrough_rate`: The click-through rate from '/products' to '/the-original-mr-fuzzy' is 61.33%.
- `mrfuzzy-clickthrough-rate`: The click-through rate from '/the-original-mr-fuzzy' to '/cart' is 60.48%.

**Interpretation:**

- The analysis in Query 1 provides insights into the number of users at each step of the conversion funnel. It identifies the drop-off rates as users progress through the funnel.
- The analysis in Query 2 calculates click-through rates, which are essential for understanding the effectiveness of guiding users through each step of the funnel.

In summary, these SQL queries and the resulting tables help assess and optimize the conversion funnel's performance for "/lander-2" traffic, particularly for users interested in "Mr. Fuzzy." The click-through rates indicate how well users are transitioning from one step to the next in the funnel.

**Request (September 5, 2012):**

Morgan, the requester, is interested in understanding the user journey of "gsearch" visitors on their website, specifically, how visitors navigate from the "/lander-1" page to placing an order. The objective is to create a full conversion funnel analysis, breaking down how many customers successfully complete each step of the process. The analysis should start at the "/lander-1" page and encompass the entire journey to the "thank you" page. The data used for this analysis spans from August 5th to September 5th, 2012.

**SQL Query 1 (Counting Users at Each Funnel Step):**

```sql
WITH
-- Step 1: Select All Pageviews for Relevant Sessions (CTE1)
cte1 AS (
    SELECT a.website_session_id, b.pageview_url, b.created_at as pageview_created_at,
    CASE WHEN pageview_url = '/products' THEN 1 ELSE 0 END AS product_page,
    CASE WHEN pageview_url = '/the-original-mr-fuzzy' THEN 1 ELSE 0 END AS mrfuzzy_page,
    CASE WHEN pageview_url = '/cart' THEN 1 ELSE 0 END AS cart_page,
    CASE WHEN pageview_url = '/shipping' THEN 1 ELSE 0 END AS shipping_page,
    CASE WHEN pageview_url = '/billing' THEN 1 ELSE 0 END AS billing_page,
    CASE WHEN pageview_url = '/thank-you-for-your-order' THEN 1 ELSE 0 END AS thanks_page
    FROM website_sessions a
    LEFT JOIN website_pageviews b ON a.website_session_id = b.website_session_id
    WHERE a.created_at BETWEEN '2012-08-05' AND '2012-09-05'
    AND utm_source = "gsearch"
    AND utm_campaign = "nonbrand"
    AND b.pageview_url IN ('/lander-1', '/products', '/the-original-mr-fuzzy', '/cart', '/shipping', '/billing', '/thank-you-for-your-order')
    ORDER BY 1, 3
),
-- Step 2: Identify Each Relevant Pageview as a Funnel Step (CTE2)
cte2 AS (
    SELECT website_session_id, 
    MAX(product_page) AS product_made_it,
    MAX(mrfuzzy_page) AS mrfuzzy_made_it,
    MAX(cart_page) AS cart_made_it,
    MAX(shipping_page) AS shipping_made_it,
    MAX(billing_page) AS billing_made_it,
    MAX(thanks_page) AS thanks_made_it
    FROM cte1
    GROUP BY 1
)
-- Step 3: Create the Session-Level Conversion Funnel View (Main Query)
SELECT 
    COUNT(DISTINCT website_session_id) AS sessions,
    COUNT(DISTINCT CASE WHEN product_made_it = 1 THEN website_session_id ELSE NULL END) AS to_product,
    COUNT(DISTINCT CASE WHEN mrfuzzy_made_it = 1 THEN website_session_id ELSE NULL END) AS to_mrfuzzy,
    COUNT(DISTINCT CASE WHEN cart_made_it = 1 THEN website_session_id ELSE NULL END) AS to_cart,
    COUNT(DISTINCT CASE WHEN shipping_made_it = 1 THEN website_session_id ELSE NULL END) AS to_shipping,
    COUNT(DISTINCT CASE WHEN billing_made_it = 1 THEN website_session_id ELSE NULL END) AS to_billing,
    COUNT(DISTINCT CASE WHEN thanks_made_it = 1 THEN website_session_id ELSE NULL END) AS to_thanks
FROM cte2;
```

**Explanation of Query 1:**

1. **Step 1 (CTE1)** selects relevant pageviews for sessions within the specified date range, focusing on "gsearch" visitors who arrived via the "nonbrand" campaign. It matches specific pageview URLs that correspond to the conversion funnel steps and assigns binary values to track if a session reached a particular step.

2. **Step 2 (CTE2)** summarizes the data by grouping it based on the website session. It calculates binary values for each session, indicating whether they reached the '/products,' '/the-original-mr-fuzzy,' '/cart,' '/shipping,' '/billing,' and '/thank-you-for-your-order' pages.

3. **Step 3 (Main Query)** calculates the following metrics:
   - `sessions`: The total number of distinct sessions that meet the criteria.
   - `to_product`: The number of sessions that reached the '/products' page (the first step of the funnel).
   - `to_mrfuzzy`: The number of sessions that reached the '/the-original-mr-fuzzy' page.
   - `to_cart`: The number of sessions that reached the '/cart' page.
   - `to_shipping`: The number of sessions that reached the '/shipping' page.
   - `to_billing`: The number of sessions that reached the '/billing' page.
   - `to_thanks`: The number of sessions that reached the '/thank-you-for-your-order' page (the final step of the funnel).

**ANSWER:**

| # sessions | to_product | to_mrfuzzy | to_cart | to_shipping | to_billing | to_thanks |
|------------|------------|------------|---------|-------------|------------|-----------|
| 4493       | 2115       | 1567       | 683     | 455         | 361        | 158       |

**SQL Query 2 (Calculating Click-Through Rates):**

```sql
WITH
-- Reusing the CTE1 and CTE2 from Query 1
-- Step 3: Create the Session-Level Conversion Funnel View (Main Query)
SELECT 
    COUNT(DISTINCT website_session_id) AS sessions,
    ROUND((COUNT(DISTINCT CASE WHEN product_made_it = 1 THEN website_session_id ELSE NULL END) / COUNT(DISTINCT website_session_id) * 100), 2) AS lander_clickthrough_rate,
    ROUND((COUNT(DISTINCT CASE WHEN mrfuzzy_made_it = 1 THEN website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN product_made_it = 1 THEN website_session_id ELSE NULL END) * 100), 2) AS product_clickthrough_rate,
    ROUND((COUNT(DISTINCT CASE WHEN cart_made_it = 1 THEN website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN mrfuzzy_made_it = 1 THEN website_session_id ELSE NULL END) * 100), 2) AS mrfuzzy_clickthrough_rate,
    ROUND((COUNT(DISTINCT CASE WHEN shipping_made_it = 1 THEN website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN cart_made_it = 1 THEN website_session_id ELSE NULL END) * 100), 2) AS cart_clickthrough_rate,
    ROUND((COUNT(DISTINCT CASE WHEN billing_made_it = 1 THEN website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN shipping_made_it = 1 THEN website_session_id ELSE NULL END) * 100), 2) AS shipping_clickthrough_rate,
    ROUND((COUNT(DISTINCT CASE WHEN thanks_made_it = 1 THEN website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN billing_m

ade_it = 1 THEN website_session_id ELSE NULL END) * 100), 2) AS billing_clickthrough_rate
FROM cte2;
```

**Explanation of Query 2:**

This query calculates the click-through rates between each step of the conversion funnel. It builds upon the CTEs created in Query 1.

- `lander_clickthrough_rate`: The percentage of sessions that proceed from "/lander-1" to "/products."
- `product_clickthrough_rate`: The percentage of sessions that progress from "/products" to "/the-original-mr-fuzzy," relative to those who reached "/products."
- `mrfuzzy_clickthrough_rate`: The percentage of sessions that advance from "/the-original-mr-fuzzy" to "/cart," relative to those who reached "/the-original-mr-fuzzy."
- `cart_clickthrough_rate`: The percentage of sessions that continue from "/cart" to "/shipping," relative to those who reached "/cart."
- `shipping_clickthrough_rate`: The percentage of sessions that move from "/shipping" to "/billing," relative to those who reached "/shipping."
- `billing_clickthrough_rate`: The percentage of sessions that reach the "/thank-you-for-your-order" page after "/billing," relative to those who reached "/billing."

**ANSWER:**

| # sessions | lander_clickthrough_rate | product_clickthrough_rate | mrfuzzy_clickthrough_rate | cart_clickthrough_rate | shipping_clickthrough_rate | billing_clickthrough_rate |
|------------|--------------------------|---------------------------|---------------------------|------------------------|----------------------------|---------------------------|
| 4493       | 47.07                    | 74.09                     | 43.59                     | 66.62                  | 79.34                      | 43.77                     |

**Interpretation of the Answers:**

- Out of 4,493 sessions initiated at "/lander-1," 2,115 sessions proceeded to the "/products" page (to_product).
- Subsequently, 1,567 sessions reached the "/the-original-mr-fuzzy" page (to_mrfuzzy).
- Of those, 683 sessions made it to the "/cart" page (to_cart).
- The funnel continues, with 455 sessions reaching the "/shipping" page (to_shipping).
- 361 sessions progressed to the "/billing" page (to_billing).
- Finally, 158 sessions successfully completed the funnel, landing on the "/thank-you-for-your-order" page (to_thanks).

**Comment by the Requester:**

The requester's comment in the initial email expressed the desire to understand where visitors arriving from "gsearch" lose interest in their website. The request specifically asked for a full conversion funnel analysis to track the number of customers at each step of the process. The data used for analysis spans from August 5th to September 5th, 2012.

The analysis enables the requester to pinpoint which step in the conversion process has the highest drop-off rate, providing insights for optimization and potential improvements.

**Request (November 10, 2012):**

Morgan, the requester, inquired about the effectiveness of an updated billing page, denoted as "/billing-2," compared to the original "/billing" page. The objective was to determine what percentage of sessions on these pages ultimately led to a successful order placement. It's worth noting that this test encompassed all website traffic, not just "gsearch" visitors. The request was made on November 10, 2012.

**SQL Query:**

```sql
-- First, finding the starting point to frame the analysis
SELECT MIN(website_pageview_id) AS first_entry 
FROM website_pageviews
WHERE pageview_url = '/billing-2';
-- 53550 is the first entry pageview id

WITH
-- CTE1: Joining Website Pageviews and Orders
cte1 AS (
    SELECT a.website_session_id, a.pageview_url AS billing_version_seen, b.order_id
    FROM website_pageviews a
    LEFT JOIN orders b ON b.website_session_id = a.website_session_id
    WHERE a.created_at < '2012-11-10' -- Time of assignment
    AND a.website_pageview_id >= 53550 -- First pageview id
    AND a.pageview_url IN ('/billing', '/billing-2')
)
-- Main Query: Calculate Billing Page Conversion Metrics
SELECT billing_version_seen,
    COUNT(DISTINCT website_session_id) AS sessions,
    COUNT(DISTINCT order_id) AS orders,
    ROUND((COUNT(DISTINCT order_id) / COUNT(DISTINCT website_session_id)) * 100, 2) AS billing_order_rt
FROM cte1
GROUP BY billing_version_seen;
```

**Explanation of the Query:**

The SQL query's purpose is to compare the performance of two billing pages, "/billing" and "/billing-2," in terms of their ability to convert visitors into customers.

1. The initial part of the query determines the starting point for the analysis. It identifies the earliest pageview ID for the "/billing-2" page. In this case, the first entry pageview ID is found to be 53550.

2. The query uses a Common Table Expression (CTE), denoted as `cte1`, to join website pageviews and order data. It selects relevant sessions where pageviews occurred before November 10, 2012 (the time of assignment) and had a pageview ID greater than or equal to 53550. It filters the data for both "/billing" and "/billing-2" pages.

3. In the main part of the query, it calculates the following metrics for each billing page version:
   - `billing_version_seen`: Indicates the version of the billing page (either "/billing" or "/billing-2").
   - `sessions`: The count of distinct website sessions that viewed the respective billing page.
   - `orders`: The count of distinct orders placed by users who viewed the billing page.
   - `billing_order_rt`: The percentage of sessions that resulted in orders on the respective billing page.

**ANSWER:**

| # billing_version_seen | sessions | orders | billing_order_rt |
|------------------------|----------|--------|------------------|
| /billing               | 657      | 300    | 45.66            |
| /billing-2             | 654      | 410    | 62.69            |

**Interpretation of the Answer:**

The query yields the following results for the two billing page versions:

- For "/billing," there were 657 sessions, resulting in 300 orders, with a billing page order conversion rate of 45.66%.
- For "/billing-2," there were 654 sessions, resulting in 410 orders, with a billing page order conversion rate of 62.69%.

**Comment by the Requester (November 10, 2012):**

Morgan expresses enthusiasm upon receiving the results, as it indicates that the new billing page version ("/billing-2") is significantly outperforming the original billing page ("/billing") in converting customers. The requester plans to have the engineering team roll out the new billing page version to all customers immediately. Morgan acknowledges that the insights provided through this analysis have contributed to a substantial increase in revenue.

This comment reflects the positive impact of data-driven decision-making on the company's bottom line.

